
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PencilPros | Checkout</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <h1>PencilPros</h1>
    <nav>
        <a href="index.html">Home</a>
        <a href="cart.html">Cart (<span id="cart-count">0</span>)</a>
        <a href="delete.html">Delete My Data</a>
        <a href="#" onclick="logout()">Logout</a>
    </nav>
</header>

<main>
    <h2>Checkout</h2>

    <div id="order-summary"></div>

    <form id="checkout-form" class="checkout-form">
        <label>Name on Card</label>
        <input type="text" id="card-name" required>

        <label>Card Number</label>
        <input type="text" id="card-number" minlength="16" maxlength="16" required>

        <label>Expiration (MM/YY)</label>
        <input type="text" id="exp" placeholder="09/27" required>

        <label>CVV</label>
        <input type="text" id="cvv" minlength="3" maxlength="4" required>

        <label>Billing Address</label>
        <textarea id="billing-address" required></textarea>

        <button type="submit">Submit Order</button>
    </form>

    <p id="confirmation" style="display:none; font-size:1.2rem; font-weight:bold; margin-top:20px;">
        Order Submitted! Thank you for shopping with PencilPros.
    </p>
</main>

<script>

    function logout() {
        // Remove all user info + cart
        localStorage.removeItem("user_id");
        localStorage.removeItem("user_name");
        localStorage.removeItem("cart");

        // Confirm to user
        alert("You've been logged out.");

        // Redirect to login page
        window.location.href = "login.html";
    }


const products = [
    { id: 0, name: "UltraSmooth Pencil", price: 2.99, img: "assets/pencil.jpg" },
    { id: 1, name: "Premium Notebook",  price: 7.49, img: "assets/notebook.jpg" },
    { id: 2, name: "Gel Pen Set",       price: 5.99, img: "assets/pens.jpg" },
    { id: 3, name: "Highlighter Pack",  price: 4.99, img: "assets/highlighters.jpg" }
];

function requireLogin() {
    const userId = localStorage.getItem("user_id");
    if (!userId) {
        alert("Please log in first.");
        window.location.href = "login.html";
    }
    return userId;
}

const currentUserId = requireLogin();
let currentTotal = 0;

function updateCartCount() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    const totalQty = cart.reduce((sum, item) => sum + item.qty, 0);
    document.getElementById("cart-count").innerText = totalQty;
}

// Render order summary and compute total
function renderOrderSummary() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    if (cart.length === 0) {
        document.getElementById("order-summary").innerHTML = "<p>Your cart is empty.</p>";
        currentTotal = 0;
        return;
    }

    let total = 0;
    const summaryHtml = cart.map(item => {
        const product = products[item.id];
        const subtotal = product.price * item.qty;
        total += subtotal;
        return `<li>${product.name} x ${item.qty} = $${subtotal.toFixed(2)}</li>`;
    }).join('');

    currentTotal = total;

    document.getElementById("order-summary").innerHTML = `
        <h3>Order Summary</h3>
        <ul>${summaryHtml}</ul>
        <h4>Total: $${total.toFixed(2)}</h4>
    `;
}

document.getElementById("checkout-form").addEventListener("submit", async function(event) {
    event.preventDefault();  // stop normal page reload

    const cardNumber = document.getElementById("card-number").value;
    const cvv = document.getElementById("cvv").value;
    const billingAddress = document.getElementById("billing-address").value.trim();

    // Simple validation
    if (!/^\d{16}$/.test(cardNumber)) {
        alert("Card number must be 16 digits");
        return;
    }
    if (!/^\d{3,4}$/.test(cvv)) {
        alert("CVV must be 3 or 4 digits");
        return;
    }
    if (!billingAddress) {
        alert("Please enter a billing address");
        return;
    }
    if (currentTotal <= 0) {
        alert("Your cart is empty");
        return;
    }

    const userId = localStorage.getItem("user_id");
    if (!userId) {
        alert("Please log in again");
        window.location.href = "login.html";
        return;
    }

    const amountCents = Math.round(currentTotal * 100);

    // DEBUG: show that we’re about to hit the backend
    console.log("Submitting purchase to backend:", {
        user_id: userId,
        item: "Cart order",
        amount_cents: amountCents,
        billing_address: billingAddress
    });

    try {
        const resp = await fetch("http://127.0.0.1:8000/purchase", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user_id: userId,
                item: "Cart order",
                amount_cents: amountCents,
                billing_address: billingAddress
            })
        });

        if (!resp.ok) {
            const text = await resp.text();
            console.error("Backend error:", resp.status, text);
            alert("Error talking to PencilPros backend. Check console.");
            return;
        }

        const data = await resp.json();
        console.log("Backend responded:", data);

        // Clear cart, show confirmation
        localStorage.removeItem("cart");
        updateCartCount();
        document.getElementById("checkout-form").style.display = "none";
        document.getElementById("order-summary").style.display = "none";
        document.getElementById("confirmation").style.display = "block";
    } catch (err) {
        console.error("Fetch exception:", err);
        alert("Network error – could not contact backend.");
    }
});

// Initialize on page load
updateCartCount();
renderOrderSummary();
</script>


</body>
</html>